# TCP 聊天软件

一个基于 Python 的安全 TCP 聊天应用，支持用户认证、多客户端连接和实时消息通信。

## 功能特性

- ✅ **用户认证系统**：支持用户注册、登录和密码重置
- ✅ **角色权限管理**：支持管理员和普通用户两种角色
- ✅ **管理员功能**：管理员可查看所有用户列表、删除任意用户账户
- ✅ **账户管理**：支持账户删除功能，需密码验证
- ✅ **安全密码存储**：使用 SHA-256 哈希算法存储密码
- ✅ **密码掩码输入**：密码输入时显示星号保护隐私
- ✅ **会话管理**：防止重复登录，自动处理连接断开
- ✅ **多客户端支持**：服务器可同时处理多个客户端连接
- ✅ **实时消息广播**：消息自动发送给所有在线用户
- ✅ **用户加入/离开通知**：系统提示用户的连接状态变化
- ✅ **时间戳记录**：每条消息都带有时间戳
- ✅ **线程安全处理**：使用多线程和锁机制处理并发连接
- ✅ **错误恢复**：网络错误自动处理和重连机制
- ✅ **易于使用**：提供批处理脚本快速启动

## 开发状态

**当前版本**：v1.0 - 用户认证系统完整实现

**已完成**：
- ✅ 核心认证功能（注册、登录、登出）
- ✅ 密码重置系统（令牌生成和验证）
- ✅ 账户删除功能
- ✅ 密码掩码输入（跨平台支持）
- ✅ 会话管理和并发控制
- ✅ 凭证持久化存储
- ✅ 完整的错误处理和用户反馈
- ✅ 管理员角色和权限系统
- ✅ 管理员代码生成和验证
- ✅ 管理员菜单（用户列表、删除用户）
- ✅ 角色基础访问控制

**进行中**：
- 🔄 测试套件开发

**计划中**：
- 📋 使用 bcrypt 或 argon2 增强密码哈希
- 📋 添加 SSL/TLS 加密传输
- 📋 实现消息持久化存储
- 📋 添加登录失败次数限制
- 📋 实现私聊功能
- 📋 添加聊天室支持

## 项目结构

```
TCPChat/
├── server.py              # TCP 聊天服务器（含认证处理）
├── client.py              # TCP 聊天客户端（含认证界面和管理员菜单）
├── auth_manager.py        # 认证管理器（用户管理、密码哈希、令牌生成、角色管理）
├── credentials.json       # 用户凭证存储文件（自动生成）
├── config.ini             # 配置文件（含管理员代码，自动生成）
├── run_server.bat         # Windows 批处理启动服务器脚本
├── run_server.ps1         # PowerShell 启动服务器脚本
├── run_client.bat         # Windows 批处理启动客户端脚本
├── run_client.ps1         # PowerShell 启动客户端脚本
├── QUICKSTART.txt         # 快速入门指南
├── ADMIN_DELETE_USAGE.md  # 管理员删除功能使用说明
└── README.md              # 本文件
```

## 系统要求

- Python 3.6 或更高版本
- Windows 系统
- 网络连接

## 使用方法

### 方式一：使用批处理脚本（Windows）

1. **启动服务器**
   - 双击 `run_server.bat` 文件
   - 或在命令行运行：`python server.py`

2. **启动客户端**
   - 双击 `run_client.bat` 文件
   - 或在命令行运行：`python client.py`

### 方式二：使用命令行

**启动服务器（在第一个终端）：**
```bash
python server.py
```

**启动客户端（在其他终端）：**
```bash
python client.py
```

## 详细说明

### 服务器 (server.py)

- **监听地址**：`0.0.0.0`（所有网卡）
- **监听端口**：`5000`
- **功能**：
  - 接受客户端连接
  - 接收客户端消息
  - 将消息广播给所有在线客户端
  - 管理客户端连接状态

**启动示例：**
```
[服务器] 启动成功，监听 0.0.0.0:5000
[服务器] 等待客户端连接...

[14:30:25] 【客户端连接】张三 (127.0.0.1:52841)
[14:30:35] 张三: 大家好
[14:30:45] 【客户端断开】张三 (在线用户数: 0)
```

### 客户端 (client.py)

- **功能**：
  - 连接到服务器
  - 用户注册和登录
  - 密码重置功能
  - 发送和接收消息
  - 实时显示消息
  - 网络错误自动处理

**使用步骤：**
1. 输入服务器地址（默认 localhost）
2. 输入服务器端口（默认 5000）
3. 选择认证操作：
   - 登录（已有账户）
   - 注册（新用户）
   - 重置密码（忘记密码）
4. 完成认证后进入聊天室
5. 输入 `logout` 或 `exit` 退出

**连接示例：**
```
==================================================
         TCP 聊天客户端
==================================================

请输入服务器地址 (默认为 localhost): 127.0.0.1
请输入服务器端口 (默认为 5000): 5000

[客户端] 已连接到 127.0.0.1:5000

==================================================
         认证菜单
==================================================
1. 登录
2. 注册
3. 注册为管理员
4. 重置密码
5. 删除账户
6. 退出
==================================================
请选择操作 (1-6): 2

--- 注册新账户 ---
用户名: 小王
密码 (至少6个字符): ******
确认密码: ******
[14:30:15] 【成功】注册成功！

注册成功！请登录。

请选择操作 (1-4): 1

--- 登录 ---
用户名: 小王
密码: ******
[14:30:25] 【成功】登录成功！欢迎 小王

==================================================
         进入聊天室
==================================================
欢迎 小王！

【系统】欢迎 小王！当前在线用户数: 1

开始聊天 (输入 'exit' 或 'logout' 退出):
管理员命令: /admin - 打开管理员菜单

> 你好，大家好
> /admin

==================================================
         管理员菜单
==================================================
1. 查看用户列表
2. 删除用户
3. 返回聊天
==================================================
请选择操作 (1-3): 1

--- 用户列表 ---

============================================================
用户名                   角色         状态
============================================================
小王                     普通用户       在线
admin                   管理员        在线
============================================================
总计: 2 个用户

> logout
[客户端] 正在断开连接...
[客户端] 已断开连接
```

## 认证协议

客户端和服务器之间使用基于文本的认证协议通信：

### 客户端命令
- `REGISTER <username> <password> [role] [admin_code]` - 注册新用户（可选管理员角色）
- `LOGIN <username> <password>` - 登录
- `RESET_REQUEST <username>` - 请求密码重置令牌
- `RESET_CONFIRM <token> <new_password>` - 使用令牌重置密码
- `DELETE_ACCOUNT <username> <password>` - 删除自己的账户
- `LIST_USERS <username>` - 查看用户列表（仅管理员）
- `ADMIN_DELETE_USER <admin_username> <target_username>` - 管理员删除用户
- `LOGOUT` - 登出

### 服务器响应
- `REGISTER_SUCCESS [role]` - 注册成功
- `REGISTER_FAILURE <error_message>` - 注册失败
- `AUTH_SUCCESS <username> <role>` - 登录成功
- `AUTH_FAILURE <error_message>` - 登录失败
- `RESET_TOKEN <token>` - 重置令牌
- `RESET_SUCCESS` - 密码重置成功
- `RESET_FAILURE <error_message>` - 密码重置失败
- `DELETE_SUCCESS` - 账户删除成功
- `DELETE_FAILURE <error_message>` - 账户删除失败
- `USER_LIST <json_data>` - 用户列表（JSON格式）
- `USER_LIST_FAILURE <error_message>` - 用户列表获取失败
- `ADMIN_DELETE_SUCCESS <username>` - 管理员删除成功
- `ADMIN_DELETE_FAILURE <error_message>` - 管理员删除失败

## 网络配置

### 本地测试
- 服务器地址：`localhost` 或 `127.0.0.1`
- 端口：`5000`

### 局域网通信
- 服务器地址：服务器机器的 IP 地址（如 `192.168.1.100`）
- 端口：`5000`

### 远程通信
- 需要配置防火墙，允许 5000 端口通过
- 使用服务器的公网 IP 地址

## 认证系统

### 用户注册
- 用户名必须唯一
- 密码长度至少 6 个字符
- 密码使用 SHA-256 哈希算法加密存储
- 注册成功后需要登录才能进入聊天室
- 支持普通用户和管理员两种角色

### 管理员注册
- 首次启动服务器时自动生成管理员代码
- 管理员代码保存在 `config.ini` 文件中
- 注册管理员需要提供正确的管理员代码
- 管理员拥有用户管理权限

### 用户登录
- 使用用户名和密码登录
- 防止同一账户重复登录
- 登录成功后自动进入聊天室
- 系统广播用户加入通知
- 管理员登录后可使用 `/admin` 命令访问管理功能

### 密码重置
- 输入用户名请求重置令牌
- 令牌有效期 30 分钟
- 使用令牌设置新密码
- 令牌使用后自动失效

### 账户删除
- 普通用户可以删除自己的账户（需要密码验证）
- 管理员可以删除任意用户账户
- 无法删除最后一个管理员账户
- 删除在线用户时会自动终止其会话

### 会话管理
- 登录后建立认证会话
- 连接断开自动清理会话
- 使用 `logout` 命令主动退出
- 退出后系统广播用户离开通知

## 管理员功能

### 管理员代码
- 服务器首次启动时自动生成随机管理员代码
- 代码显示在服务器控制台中
- 代码保存在 `config.ini` 文件的 `[Admin]` 部分
- 后续启动时从配置文件加载代码

### 用户列表
- 管理员可以查看所有注册用户
- 显示用户名、角色（管理员/普通用户）和在线状态
- 使用 `/admin` 命令进入管理员菜单，选择"查看用户列表"

### 删除用户
- 管理员可以删除任意用户账户
- 无法删除最后一个管理员账户（保证系统可管理）
- 删除在线用户时自动终止其会话
- 使用 `/admin` 命令进入管理员菜单，选择"删除用户"

### 管理员菜单
在聊天界面输入 `/admin` 打开管理员菜单：
```
==================================================
         管理员菜单
==================================================
1. 查看用户列表
2. 删除用户
3. 返回聊天
==================================================
```

## 消息格式

### 认证消息
- 成功消息：`[HH:MM:SS] 【成功】消息内容`
- 错误消息：`[HH:MM:SS] 【错误】消息内容`

### 系统消息
- 用户连接：`【系统】用户名 加入了聊天室`
- 用户断开：`【系统】用户名 离开了聊天室`
- 欢迎消息：`【系统】欢迎 用户名！当前在线用户数: N`

### 聊天消息
- 格式：`[HH:MM:SS] 用户名: 消息内容`
- 示例：`[14:30:35] 张三: 大家好`

## 故障排除

### 问题1：客户端无法连接到服务器
**症状**：
```
[错误] 无法连接到服务器 localhost:5000
[提示] 请确保服务器已启动
```

**解决方案**：
1. 确保服务器已启动
2. 检查服务器和客户端的地址和端口是否一致
3. 检查防火墙是否阻止了连接
4. 客户端会自动重试连接（最多 3 次）

### 问题2：端口已被占用
**症状**：
```
[错误] [Errno 48] Address already in use
```

**解决方案**：
1. 检查是否已有服务器在运行
2. 修改端口号（在 server.py 和 client.py 中修改 port 参数）
3. 等待一段时间后重试（TCP TIME_WAIT）

### 问题3：中文显示乱码
**症状**：消息中的中文显示为乱码

**解决方案**：
1. 确保使用 UTF-8 编码
2. 在 Windows 命令行中运行 `chcp 65001` 切换到 UTF-8 编码
3. 使用支持 UTF-8 的终端（如 PowerShell Core）

### 问题4：忘记密码
**症状**：无法登录账户

**解决方案**：
1. 在认证菜单选择"3. 重置密码"
2. 输入用户名获取重置令牌
3. 使用令牌设置新密码
4. 令牌有效期 30 分钟，过期需重新申请

### 问题5：提示"该用户已在其他地方登录"
**症状**：无法登录已登录的账户

**解决方案**：
1. 确保没有其他客户端使用该账户登录
2. 如果之前异常断开，等待服务器清理会话（通常几秒钟）
3. 或者重启服务器清除所有会话

### 问题6：凭证文件损坏
**症状**：
```
[警告] 凭证文件损坏，使用空凭证存储
```

**解决方案**：
1. 删除 `credentials.json` 文件
2. 重启服务器，系统会自动创建新的凭证文件
3. 所有用户需要重新注册

### 问题7：忘记管理员代码
**症状**：无法注册管理员账户

**解决方案**：
1. 查看服务器控制台输出（首次启动时显示）
2. 打开 `config.ini` 文件查看 `[Admin]` 部分的 `admin_code`
3. 如果文件丢失，删除 `config.ini` 并重启服务器生成新代码

### 问题8：无法访问管理员菜单
**症状**：输入 `/admin` 提示"此命令仅限管理员使用"

**解决方案**：
1. 确保使用管理员账户登录
2. 检查注册时是否使用了正确的管理员代码
3. 管理员角色在登录成功时会显示"欢迎 用户名 (管理员)"

## 技术架构

### 服务器端 (server.py)
- **多线程架构**：每个客户端连接使用独立线程处理
- **线程安全**：使用 `threading.Lock()` 保护共享资源
- **认证集成**：集成 `AuthenticationManager` 处理认证流程
- **广播机制**：消息自动广播给所有已认证的在线用户

### 客户端 (client.py)
- **双线程设计**：
  - 主线程：处理用户输入和消息发送
  - 后台线程：接收服务器消息
- **认证流程**：连接后先进行认证，成功后才能进入聊天
- **错误处理**：网络错误自动重试和恢复机制
- **超时控制**：连接超时 10 秒，操作超时 5 秒

### 认证管理器 (auth_manager.py)
- **凭证存储**：JSON 文件存储用户信息和角色
- **密码哈希**：SHA-256 算法
- **令牌生成**：使用 `secrets` 模块生成安全令牌
- **角色管理**：支持管理员和普通用户角色
- **管理员代码**：使用 `configparser` 管理管理员代码
- **线程安全**：所有操作使用锁保护
- **自动持久化**：数据变更立即保存到文件

## 性能指标

- **最大连接数**：取决于系统资源，通常 100+ 个并发连接
- **消息延迟**：毫秒级别（取决于网络）
- **吞吐量**：受限于网络带宽
- **认证性能**：SHA-256 哈希计算快速，单次认证 < 10ms
- **文件 I/O**：JSON 读写，适合小规模用户（< 1000 用户）

## 安全特性

✅ **已实现的安全功能**：

1. **用户认证**：完整的注册、登录和密码重置系统
2. **密码哈希**：使用 SHA-256 算法加密存储密码
3. **会话管理**：防止重复登录，自动清理断开连接
4. **令牌系统**：密码重置使用安全令牌，30 分钟有效期
5. **文件权限**：凭证文件在 Unix 系统上设置为仅所有者可读写（600）
6. **线程安全**：使用锁机制保护并发访问
7. **角色权限**：基于角色的访问控制（RBAC），管理员和普通用户权限分离
8. **管理员代码**：使用随机生成的代码保护管理员注册
9. **最后管理员保护**：防止删除最后一个管理员账户

## 安全注意事项

⚠️ **此应用为教育/演示程序，生产环境使用前请注意**：

1. **无传输加密**：消息和密码以明文在网络传输
2. **无消息持久化**：消息不存储，服务器重启后消息丢失
3. **简单哈希**：使用 SHA-256 但未加盐，建议生产环境使用 bcrypt 或 argon2
4. **无速率限制**：没有防止暴力破解的速率限制
5. **无日志审计**：没有详细的安全日志记录

**生产环境建议**：
- 使用 SSL/TLS 加密传输（如 Python 的 ssl 模块）
- 使用加盐哈希算法（如 bcrypt、argon2）
- 实现消息持久化存储（数据库）
- 添加登录失败次数限制和账户锁定
- 实现详细的安全审计日志
- 添加用户权限和角色管理
- 实现消息审核和过滤机制

## 扩展功能建议

1. **私聊功能**：支持用户之间的私密消息
2. **聊天室**：支持创建多个聊天室
3. **消息历史**：保存和查询消息历史
4. **文件传输**：支持文件分享
5. **表情符号**：支持 emoji 和其他富文本
6. **数据库存储**：使用 SQLite 或 PostgreSQL 持久化存储
7. **SSL/TLS 加密**：使用 Python ssl 模块加密通信
8. **更多管理员功能**：踢人、禁言、删除消息、修改用户角色等
9. **用户资料**：头像、个性签名等个人信息
10. **消息已读状态**：显示消息是否已被阅读
11. **离线消息**：用户离线时保存消息，上线后推送
12. **审计日志**：记录管理员操作和安全事件
